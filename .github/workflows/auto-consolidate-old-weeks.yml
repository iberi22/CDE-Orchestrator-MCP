name: Auto-Consolidate Old Weeks

on:
  # Trigger on push to main (cuando se agregan nuevos reportes)
  push:
    branches:
      - main
    paths:
      - 'agent-docs/execution/*.md'
      - 'agent-docs/sessions/*.md'

  # Manual trigger para testing
  workflow_dispatch:

env:
  GIT_AUTHOR_NAME: "Jules Consolidator Bot"
  GIT_AUTHOR_EMAIL: "jules@cde-orchestrator.dev"
  GIT_COMMITTER_NAME: "Jules Consolidator Bot"
  GIT_COMMITTER_EMAIL: "jules@cde-orchestrator.dev"

jobs:
  detect-and-consolidate:
    name: Detect & Consolidate Old Weeks
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml python-dateutil

      - name: ðŸ” Detect old weeks needing consolidation
        id: detect
        run: |
          python scripts/consolidation/detect-old-weeks.py

      - name: ðŸš€ Run consolidation for old weeks
        if: steps.detect.outputs.has_old_weeks == 'true'
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          echo "ðŸ”„ Consolidating ${{ steps.detect.outputs.old_weeks_count }} old weeks..."
          echo "Current week (${{ steps.detect.outputs.current_week }}) will be skipped (left for Sunday)"

          python scripts/consolidation/weekly-consolidation-with-jules.py --skip-current-week

      - name: ðŸ“Š Check consolidation results
        if: steps.detect.outputs.has_old_weeks == 'true'
        id: check
        run: |
          CONSOLIDATED=$(find agent-docs/execution -name "WEEKLY-CONSOLIDATION-*.md" -type f | wc -l)
          echo "consolidated_files=$CONSOLIDATED" >> $GITHUB_OUTPUT

          if [ $CONSOLIDATED -gt 0 ]; then
            echo "âœ… Successfully consolidated $CONSOLIDATED weeks"
          else
            echo "âš ï¸  No consolidated files generated"
          fi

      - name: ðŸ”€ Create pull request
        if: steps.detect.outputs.has_old_weeks == 'true' && steps.check.outputs.consolidated_files > 0
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: |
            chore(docs): auto-consolidate old weeks (${{ steps.detect.outputs.old_weeks_count }} weeks)

            - Detected ${{ steps.detect.outputs.old_weeks_count }} completed weeks
            - Oldest week: ${{ steps.detect.outputs.oldest_week }}
            - Current week: ${{ steps.detect.outputs.current_week }} (skipped, left for Sunday)
            - Generated weekly summaries via Jules API
          branch: auto-consolidate-${{ github.run_number }}
          title: 'chore(docs): Auto-consolidate old weeks - ${{ steps.detect.outputs.old_weeks_count }} weeks'
          body: |
            ## ðŸ¤– Auto-Consolidation Report

            This PR was automatically triggered when new files were pushed to `agent-docs/`.

            ### Detection
            - **Old weeks found**: ${{ steps.detect.outputs.old_weeks_count }}
            - **Oldest week**: ${{ steps.detect.outputs.oldest_week }}
            - **Current week**: ${{ steps.detect.outputs.current_week }} (â­ï¸ skipped for Sunday consolidation)

            ### What Happened
            1. ðŸ” Detected new files pushed to `agent-docs/execution/` or `agent-docs/sessions/`
            2. ðŸ“… Analyzed file dates and grouped by ISO week
            3. ðŸŽ¯ Identified completed weeks (not current week)
            4. ðŸ¤– Called Jules API to consolidate old weeks
            5. â³ Waited for Jules to complete processing
            6. ðŸ“ Generated `WEEKLY-CONSOLIDATION-{YYYY-WW}.md` files

            ### Consolidation Results
            - **Files consolidated**: ${{ steps.check.outputs.consolidated_files }} weeks
            - **Current week files**: Left untouched for Sunday's scheduled consolidation

            ### Why This Workflow
            This workflow ensures:
            - Old weeks are consolidated immediately (don't wait until Sunday)
            - Current week files accumulate until Sunday
            - Prevents document sprawl in `agent-docs/`
            - Automatic organization without manual intervention

            ---

            **Next Steps**: Review and merge. Sunday's workflow will handle current week.

            *Triggered by push to `{{ github.ref }}`*
            *Powered by Jules API*
          labels: |
            documentation
            automation
            auto-consolidation
          reviewers: |
            iberi22

      - name: ðŸ“¬ Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          # Auto-Consolidation Report

          ## Detection Results
          - **Old weeks found**: ${{ steps.detect.outputs.has_old_weeks == 'true' && steps.detect.outputs.old_weeks_count || '0' }}
          - **Current week**: ${{ steps.detect.outputs.current_week }}
          - **Status**: ${{ steps.detect.outputs.has_old_weeks == 'true' && 'âœ… Consolidated' || 'â­ï¸ No action needed' }}

          ## Logic
          1. **Detect**: Scan `agent-docs/execution/` and `agent-docs/sessions/`
          2. **Group**: Organize files by ISO week (Monday-Sunday)
          3. **Filter**: Identify weeks older than current week
          4. **Consolidate**: Call Jules API for intelligent summarization
          5. **Skip**: Leave current week for Sunday's scheduled workflow

          ## Why This Workflow?
          - âš¡ **Immediate**: Consolidates old weeks on every push
          - ðŸŽ¯ **Smart**: Only processes completed weeks
          - ðŸ“… **Deferred**: Current week waits until Sunday
          - ðŸ¤– **Automated**: No manual intervention

          ---

          *Next run: On next push to `agent-docs/`*
          EOF

      - name: â„¹ï¸ No action needed
        if: steps.detect.outputs.has_old_weeks != 'true'
        run: |
          echo "âœ… All files are from current week ${{ steps.detect.outputs.current_week }}"
          echo "â­ï¸  No consolidation needed. Waiting for Sunday's scheduled run."

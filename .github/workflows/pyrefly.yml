name: Pyrefly Type Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  type-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.14
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
        cache: 'pip'

    - name: Install Pyrefly
      run: |
        pip install pyrefly

    - name: Run Pyrefly Type Check
      run: |
        pyrefly check src
      continue-on-error: true

    - name: Generate Pyrefly Report
      if: always()
      run: |
        python scripts/pyrefly_report.py

    - name: Upload Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pyrefly-report
        path: agent-docs/execution/EXECUTIONS-pyrefly-*.md
        retention-days: 30

    - name: Comment PR with Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportFiles = fs.readdirSync('agent-docs/execution/')
            .filter(f => f.startsWith('EXECUTIONS-pyrefly-'));

          if (reportFiles.length > 0) {
            const reportPath = `agent-docs/execution/${reportFiles[0]}`;
            const report = fs.readFileSync(reportPath, 'utf8');

            // Extract summary from report
            const summaryMatch = report.match(/Total de errores\*\*: (\d+)/);
            const totalErrors = summaryMatch ? summaryMatch[1] : 'unknown';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç Pyrefly Type Check Results\n\n**Total Errors:** ${totalErrors}\n\nüìÑ [Full Report Available in Artifacts](${context.payload.pull_request.html_url}/checks)`
            });
          }

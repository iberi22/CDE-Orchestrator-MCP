name: Weekly Documentation Consolidation (Jules)

on:
  schedule:
    # Every Sunday at 23:00 UTC
    - cron: '0 23 * * 0'

  workflow_dispatch:
    inputs:
      week:
        description: 'Week to consolidate (YYYY-WXX format, empty for current)'
        required: false
        default: ''
      skip_cleanup:
        description: 'Skip cleanup of consolidated files'
        required: false
        default: 'false'

env:
  GIT_AUTHOR_NAME: "Jules Consolidator Bot"
  GIT_AUTHOR_EMAIL: "jules@cde-orchestrator.dev"
  GIT_COMMITTER_NAME: "Jules Consolidator Bot"
  GIT_COMMITTER_EMAIL: "jules@cde-orchestrator.dev"

jobs:
  consolidate:
    name: Weekly Consolidation
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml python-dateutil

      - name: ðŸ” Scan documentation files
        id: scan
        run: |
          EXEC_COUNT=$(find agent-docs/execution -maxdepth 1 -name "*.md" -type f ! -name "WEEKLY-*" ! -name "FINAL-*" ! -name "INTEGRATION-*" | wc -l)
          SESS_COUNT=$(find agent-docs/sessions -maxdepth 1 -name "*.md" -type f ! -name "WEEKLY-*" | wc -l)

          echo "execution_count=$EXEC_COUNT" >> $GITHUB_OUTPUT
          echo "sessions_count=$SESS_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Found $EXEC_COUNT execution files"
          echo "âœ… Found $SESS_COUNT session files"

      - name: ðŸ¤– Consolidate execution/ with Jules
        id: consolidate_execution
        if: steps.scan.outputs.execution_count > 0
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          python scripts/consolidation/consolidate-execution-with-jules.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ¤– Consolidate sessions/ with Jules
        id: consolidate_sessions
        if: steps.scan.outputs.sessions_count > 0
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          python scripts/consolidation/consolidate-sessions-with-jules.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: âœ… Verify consolidations
        id: verify
        run: |
          WEEK=$(python -c "from datetime import datetime; w=datetime.now().isocalendar(); print(f'{w[0]}-W{w[1]:02d}')")

          EXEC_FILE="agent-docs/execution/WEEKLY-CONSOLIDATION-EXECUTION-${WEEK}.md"
          SESS_FILE="agent-docs/sessions/WEEKLY-CONSOLIDATION-SESSIONS-${WEEK}.md"

          EXEC_EXISTS=false
          SESS_EXISTS=false

          if [ -f "$EXEC_FILE" ] && [ $(wc -c < "$EXEC_FILE") -gt 1000 ]; then
            echo "âœ… Execution consolidation verified: $EXEC_FILE"
            EXEC_EXISTS=true
          fi

          if [ -f "$SESS_FILE" ] && [ $(wc -c < "$SESS_FILE") -gt 1000 ]; then
            echo "âœ… Sessions consolidation verified: $SESS_FILE"
            SESS_EXISTS=true
          fi

          echo "execution_consolidated=$EXEC_EXISTS" >> $GITHUB_OUTPUT
          echo "sessions_consolidated=$SESS_EXISTS" >> $GITHUB_OUTPUT

      - name: ðŸ§¹ Cleanup consolidated files
        id: cleanup
        if: |
          github.event.inputs.skip_cleanup != 'true' &&
          (steps.verify.outputs.execution_consolidated == 'true' || steps.verify.outputs.sessions_consolidated == 'true')
        run: |
          python scripts/consolidation/cleanup-after-consolidation.py \
            --execution-consolidated=${{ steps.verify.outputs.execution_consolidated }} \
            --sessions-consolidated=${{ steps.verify.outputs.sessions_consolidated }}

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Generate summary
        id: summary
        run: |
          WEEK=$(python -c "from datetime import datetime; w=datetime.now().isocalendar(); print(f'{w[0]}-W{w[1]:02d}')")

          cat > /tmp/summary.md <<EOF
          # ðŸ“Š Weekly Consolidation Summary

          **Week**: $WEEK
          **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ## Scanned Files
          - Execution files: ${{ steps.scan.outputs.execution_count }}
          - Session files: ${{ steps.scan.outputs.sessions_count }}

          ## Consolidation Results
          - Execution: ${{ steps.consolidate_execution.outputs.status || 'skipped' }}
          - Sessions: ${{ steps.consolidate_sessions.outputs.status || 'skipped' }}

          ## Verification
          - Execution consolidated: ${{ steps.verify.outputs.execution_consolidated }}
          - Sessions consolidated: ${{ steps.verify.outputs.sessions_consolidated }}

          ## Cleanup
          - Status: ${{ steps.cleanup.outputs.status || 'skipped' }}

          ## Output Files
          EOF

          if [ "${{ steps.verify.outputs.execution_consolidated }}" == "true" ]; then
            echo "- âœ… \`agent-docs/execution/WEEKLY-CONSOLIDATION-EXECUTION-${WEEK}.md\`" >> /tmp/summary.md
          fi

          if [ "${{ steps.verify.outputs.sessions_consolidated }}" == "true" ]; then
            echo "- âœ… \`agent-docs/sessions/WEEKLY-CONSOLIDATION-SESSIONS-${WEEK}.md\`" >> /tmp/summary.md
          fi

          cat /tmp/summary.md

      - name: ðŸ”€ Create pull request
        if: steps.verify.outputs.execution_consolidated == 'true' || steps.verify.outputs.sessions_consolidated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: |
            chore(docs): Weekly consolidation for ${{ env.WEEK }}

            Consolidated documentation with Jules AI:
            - Execution files: ${{ steps.scan.outputs.execution_count }} â†’ 1 summary
            - Session files: ${{ steps.scan.outputs.sessions_count }} â†’ 1 summary
            - Cleanup: ${{ steps.cleanup.outputs.status || 'skipped' }}
          branch: weekly-consolidation-${{ github.run_number }}
          title: 'chore(docs): Weekly consolidation - Week ${{ env.WEEK }}'
          body: |
            ## ðŸ“Š Weekly Documentation Consolidation

            Automated consolidation using Jules AI for week **${{ env.WEEK }}**.

            ### Files Processed
            - **Execution**: ${{ steps.scan.outputs.execution_count }} files
            - **Sessions**: ${{ steps.scan.outputs.sessions_count }} files

            ### Output
            ${{ steps.verify.outputs.execution_consolidated == 'true' && '- âœ… Execution consolidated' || '- â­ï¸ No execution files' }}
            ${{ steps.verify.outputs.sessions_consolidated == 'true' && '- âœ… Sessions consolidated' || '- â­ï¸ No session files' }}

            ### Changes
            - New consolidation summaries in respective folders
            - Original files ${{ steps.cleanup.outputs.status == 'success' && 'archived/deleted' || 'preserved (manual cleanup needed)' }}

            ### Process
            1. Scanned `agent-docs/execution/` and `agent-docs/sessions/`
            2. Called Jules API for intelligent consolidation (separate for each folder)
            3. Generated weekly summaries per folder
            4. ${{ steps.cleanup.outputs.status == 'success' && 'Cleaned up original files' || 'Preserved original files (manual cleanup)' }}

            ---
            *Powered by Jules AI - Asynchronous code consolidation*
            *Automation: `.github/workflows/weekly-consolidation-jules-separated.yml`*
          labels: |
            documentation
            automation
            consolidation
          reviewers: |
            iberi22

      - name: ðŸ“¬ Create workflow summary
        run: |
          WEEK=$(python -c "from datetime import datetime; w=datetime.now().isocalendar(); print(f'{w[0]}-W{w[1]:02d}')")

          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          # ðŸ“Š Weekly Consolidation Complete

          ## Results
          - **Week**: $WEEK
          - **Execution Files**: ${{ steps.scan.outputs.execution_count }} scanned
          - **Session Files**: ${{ steps.scan.outputs.sessions_count }} scanned
          - **Status**: ${{ (steps.verify.outputs.execution_consolidated == 'true' || steps.verify.outputs.sessions_consolidated == 'true') && 'âœ… Success' || 'âš ï¸ Partial' }}

          ## Consolidations
          ${{ steps.verify.outputs.execution_consolidated == 'true' && '- âœ… `execution/WEEKLY-CONSOLIDATION-EXECUTION-' + env.WEEK + '.md`' || '- â­ï¸ No execution consolidation' }}
          ${{ steps.verify.outputs.sessions_consolidated == 'true' && '- âœ… `sessions/WEEKLY-CONSOLIDATION-SESSIONS-' + env.WEEK + '.md`' || '- â­ï¸ No sessions consolidation' }}

          ## Cleanup
          - ${{ steps.cleanup.outputs.status == 'success' && 'âœ… Original files cleaned up' || 'âš ï¸ Manual cleanup required' }}

          ## What Happened
          1. Scanned both documentation folders
          2. Jules AI analyzed and consolidated each folder separately
          3. Generated weekly summaries **per folder** (execution + sessions)
          4. ${{ steps.cleanup.outputs.status == 'success' && 'Automatically cleaned up originals' || 'Preserved originals (review before cleanup)' }}

          ## Next Steps
          - Review the auto-generated PR
          - Verify consolidation quality
          - Merge when ready

          ---
          *Powered by Jules AI*
          EOF

      - name: ðŸ”” Notify failure
        if: failure()
        run: |
          echo "âŒ Consolidation workflow failed"
          echo "Check logs for details"
          exit 1

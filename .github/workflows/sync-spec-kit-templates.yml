name: Sync Spec-Kit Templates

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

  workflow_dispatch:
    inputs:
      force:
        description: 'Force overwrite existing templates'
        required: false
        default: 'false'
        type: boolean

  repository_dispatch:
    types: [spec-kit-release]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CDE Orchestrator MCP
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Create temp directory for Spec-Kit templates
        run: mkdir -p /tmp/spec-kit-templates

      - name: Download Spec-Kit templates
        run: |
          echo "ðŸ“¥ Downloading templates from github/spec-kit..."

          # Base URL for raw content
          BASE_URL="https://raw.githubusercontent.com/github/spec-kit/main/templates"

          # Download each template
          curl -f -o /tmp/spec-kit-templates/spec-template.md "$BASE_URL/spec-template.md" || echo "âš ï¸ spec-template.md not found"
          curl -f -o /tmp/spec-kit-templates/plan-template.md "$BASE_URL/plan-template.md" || echo "âš ï¸ plan-template.md not found"
          curl -f -o /tmp/spec-kit-templates/tasks-template.md "$BASE_URL/tasks-template.md" || echo "âš ï¸ tasks-template.md not found"

          # Alternative names (try both)
          curl -f -o /tmp/spec-kit-templates/spec.md "$BASE_URL/spec.md" 2>/dev/null || true
          curl -f -o /tmp/spec-kit-templates/plan.md "$BASE_URL/plan.md" 2>/dev/null || true
          curl -f -o /tmp/spec-kit-templates/tasks.md "$BASE_URL/tasks.md" 2>/dev/null || true

          echo "âœ… Download complete"
          ls -lh /tmp/spec-kit-templates/

      - name: Backup current templates
        run: |
          echo "ðŸ’¾ Backing up current templates..."
          mkdir -p /tmp/backup-templates
          cp -r specs/templates/* /tmp/backup-templates/ 2>/dev/null || echo "No existing templates to backup"

      - name: Customize templates with CDE extensions
        run: |
          echo "ðŸ”§ Applying CDE customizations..."

          python scripts/customize_templates.py \
            --batch \
            --input-dir /tmp/spec-kit-templates \
            --output-dir specs/templates

          echo "âœ… Customization complete"

      - name: Validate conformity
        id: validate
        run: |
          echo "ðŸ” Validating Spec-Kit conformity..."

          python scripts/validate_spec_kit_conformity.py \
            --templates specs/templates/ \
            --min-score 95 \
            --output conformity-report.json || true

          # Extract score for PR description
          SCORE=$(python -c "import json; print(json.load(open('conformity-report.json'))['average_score'])")
          echo "conformity_score=$SCORE" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Conformity Score: $SCORE/100"

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet specs/templates/ || echo "has_changes=true" >> $GITHUB_OUTPUT

          if git diff --quiet specs/templates/; then
            echo "âœ… No template changes detected"
          else
            echo "ðŸ”„ Template changes detected"
            git diff specs/templates/
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ chore(spec-kit): Sync templates from upstream

            - Downloaded latest templates from github/spec-kit
            - Applied CDE customizations (llm_summary, MCP tools, etc.)
            - Conformity Score: ${{ steps.validate.outputs.conformity_score }}/100

            Auto-generated by sync-spec-kit-templates workflow
          branch: sync-spec-kit-templates-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ”„ Sync Spec-Kit Templates'
          body: |
            ## ðŸ”„ Spec-Kit Template Synchronization

            **Automated sync from**: `github/spec-kit` (main branch)
            **Triggered**: ${{ github.event_name }}
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---

            ### ðŸ“Š Validation Results

            **Conformity Score**: ${{ steps.validate.outputs.conformity_score }}/100
            **Minimum Required**: 95/100
            **Status**: ${{ steps.validate.outputs.conformity_score >= 95 && 'âœ… PASSED' || 'âš ï¸ NEEDS REVIEW' }}

            ---

            ### ðŸ”§ Customizations Applied

            - âœ… Added `llm_summary` to YAML frontmatter (AI optimization)
            - âœ… Added "MCP Tools Available" section to `spec.md`
            - âœ… Added "Hexagonal Architecture Patterns" to `plan.md`
            - âœ… Added "Phase Tracking" section to `tasks.md`

            ---

            ### ðŸ“‹ Changed Files

            ```
            specs/templates/spec.md
            specs/templates/plan.md
            specs/templates/tasks.md
            ```

            ---

            ### ðŸ” Review Checklist

            - [ ] Conformity score is 95% or higher
            - [ ] CDE customizations are present and correct
            - [ ] YAML frontmatter is valid
            - [ ] Required sections are present
            - [ ] No breaking changes to existing features

            ---

            ### ðŸš€ Next Steps

            1. Review changes in this PR
            2. Verify conformity report (attached artifact)
            3. Test with `cde_generateSpec` tool
            4. Merge if all checks pass

            ---

            **Auto-merge**: Disabled (requires human review)
            **Delete branch**: Enabled (after merge)
          labels: |
            sync
            spec-kit
            automated
            templates
          assignees: ${{ github.repository_owner }}

      - name: Upload conformity report
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: conformity-report
          path: conformity-report.json
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes**: ${{ steps.check_changes.outputs.has_changes == 'true' && 'âœ… PR Created' || 'âœ… No Changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Conformity**: ${{ steps.validate.outputs.conformity_score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Pull request created for review" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Templates are up-to-date" >> $GITHUB_STEP_SUMMARY
          fi
